"use strict";

let User = require('../');

module.exports = function *register(next){
  if(Object.prototype.toString.call(this.request.body) !== '[object Object]'){
    throw new Error('Bad request');
  }
  if(!this.request.body.email || !this.request.body.password){
    let err = 'Required: ';
    if(!this.request.body.email) err += " * email";
    if(!this.request.body.password) err += " * password";
    throw new Error(err);
  }
  yield User.model.findOne({ email: this.request.body.email }).exec().then(
    function(user) { if(user) { throw new Error('email already exists, try logging in or resetting your password') }},
    function(err) { throw err }
  );
  var user = yield User.model.create({
    email: this.request.body.email,
    password: this.request.body.password
  }).then(
    function(user){
      if(!user) throw new Error('failed to create user');
      return user;
    },
    function(err) {
      throw err;
    }
  );
  this.session.uid = user._id;
  this.state.user = user;
  yield next;
};
