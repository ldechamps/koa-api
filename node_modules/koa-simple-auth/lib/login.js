"use strict";

var User = require('../');

module.exports = function *login(next){
  try{
    if(Object.prototype.toString.call(this.request.body) !== '[object Object]' || !this.request.body.email || !this.request.body.password){
      throw new Error('bad request');
    }
    var user = yield User.model.findOne({email: this.request.body.email}).exec().then(
      function(user){
        if(!user) throw new Error('email address not found');
        return user;
      },
      function(err){ throw err; }
    );
    if(!user.validatePassword(this.request.body.password)) {
      throw new Error('invalid password');
    }
    this.session.uid = user._id;
    this.state.user = user.toObject();
  } catch(err){
    delete this.session.uid;
    delete this.state.user;
    throw err;
  }
  yield next;
};